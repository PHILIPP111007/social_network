<!DOCTYPE html>
{% load static %}

<html>
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ global_user.first_name }} {{ global_user.last_name }}</title>
	<link rel="stylesheet" href='{% static "css/main.css" %}'>
	<link rel="stylesheet" href='{% static "css/room.css" %}'>
	<style>
		{% if settings.theme %}
			body {
				background-color: rgb(250, 244, 244);
			}
		{% else %}
			body {
				background-color: rgb(220, 244, 244);
			}
		{% endif %}
		.{{ global_user.username }} {
			background-color: rgb(121, 202, 39);
		}
		.{{ friend.username }} {
			background-color: rgb(173, 173, 173);
		}
	</style>
</head>
<body>
	<div id="upper-div"></div>

	<div class="upper-line">
		<div>
			<h5>{{ global_user.first_name }}</h5>
			<nav id="navigation">
				<img id="toggleTextarea" class="menu_burger_icon" src="{% static 'images/lines_menu_burger_icon_123889.svg' %}" width="30" height="22" alt="menu bar">
			</nav>
		</div>
	</div>

	<div class="settings-bar">
		<form id="backgroundColorChangeForm" method="POST" action="background_color_change/">
			{% csrf_token %}
			<input type="submit" value="Change theme">
		</form>
	</div>

	<aside class="left-list">
		<nav>
			<p class="menu-link"><a href="{% url 'user' global_user.username %}">Homepage</a></p>
			<p class="menu-link"><a href="{% url 'dialogs' global_user.username %}" style="background-color: rgb(205,205,205);">Messenger</a></p>
			<p class="menu-link"><a href="{% url 'friends' global_user.username %}">Friends</a></p>
			<p class="menu-link"><a href="{% url 'news' global_user.username %}">News</a></p>
		</nav>
	</aside>

	<div class="main-content">

		<div class="chat" align="center">
			<div id="containerScroll" class="container_Scrollbottom" >
				<div id="id_chat_item_container" class="chat_item_container" >
					{% for msg in messages %}
						<div class="{{ msg.sender }}">
							<h5>{{ msg.sender }}</h5>
							<div class="text">{{ msg.message|urlize }}</div>
						</div>
					{% endfor %}
				</div>
				<div class="wrapper_Scrollbottom"></div>
			</div>
		
			<div class="input-zone" align="center">
				@{{ friend.username }}<br>
				<input type="text" id="id_message_send_input" maxlength="1000">
				<button type="submit" id="id_message_send_button">send</button>
			</div>
		</div>

		<script>
			function lastMessageScroll(b) {
				var e = document.querySelector('.wrapper_Scrollbottom');
				if (!e) return ;
			
				e.scrollIntoView({
					behavior: b || 'auto',
					block: 'end',
				});
			};
		</script>


		{{ room_name|json_script:"room-name" }}
		{{ global_user.username|json_script:"global-user" }}
		{{ low_power_mode|json_script:"low-power-mode" }}


		<script>
			const roomName = JSON.parse(document.getElementById('room-name').textContent);
			const globalUser = JSON.parse(document.getElementById('global-user').textContent);
			const chatSocket = new WebSocket(
				'ws://'
				+ window.location.host
				+ '/ws/chat/'
				+ roomName
				+ '/'
			);


			chatSocket.onopen = function (e) {
				console.log("The connection was setup successfully !");
				lastMessageScroll();
			};
			chatSocket.onclose = function (e) {
				console.log("Something unexpected happened !");
			};


			document.querySelector("#id_message_send_input").focus();
			document.querySelector("#id_message_send_input").onkeyup = function (e) {
				if (e.keyCode == 13) {
					document.querySelector("#id_message_send_button").click();
				}
			};
			document.querySelector("#id_message_send_button").onclick = function (e) {
				
				var messageInput = document.querySelector(
					"#id_message_send_input"
				).value;

				if (messageInput) {
					chatSocket.send(JSON.stringify({ message: messageInput, username: globalUser}));
				};

			};
			chatSocket.onmessage = function (e) {
				const data = JSON.parse(e.data);
				const lowPowerMode = JSON.parse(document.getElementById('low-power-mode').textContent)
				
				var div = document.createElement('div');
				var userP = document.createElement('h5');
				var messageDiv = document.createElement('div');
				
				userP.innerHTML = data.username;
				messageDiv.innerHTML = data.message;

				div.className = data.username;
				messageDiv.className = 'text';

				div.appendChild(userP)
				div.appendChild(messageDiv)

				document.querySelector("#id_message_send_input").value = "";
				document.querySelector("#id_chat_item_container").appendChild(div);
		
				// Запускаем функцию скролла (если убрать "smooth", то скролл будет мгновенным)
				if (!lowPowerMode) {
					lastMessageScroll();
				} else {
					lastMessageScroll("smooth");
				}
			};
		</script>
	</div>

	<script src="{% static 'js/main.js' %}" type="text/javascript" charset="utf-8" async defer></script>

</body>
</html>